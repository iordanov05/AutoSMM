import logging
from sqlalchemy.orm import Session
from langchain_openai import ChatOpenAI
from app.models import Group, Post, Product, Service
from app.services.rag import get_group_vectorstore
from app.core.config import OPENROUTER_API_KEY, AI_MODEL

logger = logging.getLogger(__name__)

llm = ChatOpenAI(
    openai_api_key=OPENROUTER_API_KEY,
    base_url="https://openrouter.ai/api/v1",
    model_name=AI_MODEL,
    temperature=0.5,
    max_tokens=3000
)


def generate_post_from_context(db: Session, query: str, vk_group_id: int, history: str = "") -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ ChromaDB –¥–ª—è —Å–æ–æ–±—â–µ—Å—Ç–≤–∞.
    –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è fallback-–ø–æ–∏—Å–∫ –ø–æ –ø—É—Å—Ç–æ–º—É –∑–∞–ø—Ä–æ—Å—É.
    """
    vectorstore = get_group_vectorstore(vk_group_id)
    retriever = vectorstore.as_retriever(search_kwargs={"k": 5})
    
    try:
        results = retriever.invoke(query)
        docs = results if isinstance(results, list) else [results]
        logger.info(f"–ù–∞–π–¥–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: {len(docs)} –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞: {query}")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–ª—è vk_group_id {vk_group_id}: {e}")
        docs = []
    
    if not docs or all(not doc.page_content.strip() for doc in docs):
        logger.warning(f"–ù–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è vk_group_id {vk_group_id} –ø–æ –∑–∞–ø—Ä–æ—Å—É: {query}. –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback.")
        try:
            fallback_results = retriever.invoke("")
            docs = fallback_results if isinstance(fallback_results, list) else [fallback_results]
            logger.info(f"Fallback –Ω–∞–π–¥–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: {len(docs)}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ fallback –ø–æ–∏—Å–∫–∞: {e}")
            docs = []
    
    context_texts = "\n\n".join([doc.page_content for doc in docs if doc.page_content.strip()])
    if not context_texts.strip():
        context_texts = """
        –£ –Ω–∞—Å –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≥—Ä—É–ø–ø–µ.  
        –ü—Ä–µ–∂–¥–µ —á–µ–º —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∫–ª–∞–º–Ω—ã–π –ø–æ—Å—Ç, —É—Ç–æ—á–Ω–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:  
        - –û —á—ë–º —ç—Ç–∞ –≥—Ä—É–ø–ø–∞?  
        - –ö–∞–∫–∏–µ —Ç–æ–≤–∞—Ä—ã –∏–ª–∏ —É—Å–ª—É–≥–∏ –æ–Ω–∞ –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç?  
        - –ö–∞–∫–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –≤ –ø–æ—Å—Ç–∞—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª–µ–Ω? (—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π, –¥—Ä—É–∂–µ—Å–∫–∏–π, —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π)  
        - –ï—Å—Ç—å –ª–∏ –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–æ—à–ª—ã—Ö –ø–æ—Å—Ç–æ–≤ –∏–ª–∏ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤?  

        –ó–∞–ø—Ä–æ—Å–∏ —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–æ—Å—Ç–∞.  
        –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å—Ä–∞–∑—É —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø—É–±–ª–∏–∫–∞—Ü–∏—é.
        """
        
    prompt = f"""
    –¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥ –∏ –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä. –¢—ã –∏–∑—É—á–∏–ª –≥—Ä—É–ø–ø—É –í–ö–æ–Ω—Ç–∞–∫—Ç–µ –∏ –µ—ë —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è. 
    –¢–µ–ø–µ—Ä—å —Ç—ã –æ—Ç–≤–µ—á–∞–µ—à—å –Ω–∞ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞—è—Å—å —Å—Ç–∏–ª—è –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ.

    üîπ **–ò—Å—Ç–æ—Ä–∏—è –æ–±—â–µ–Ω–∏—è (–¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)**:  
    {history}

    üîπ **–î–∞–Ω–Ω—ã–µ –æ –≥—Ä—É–ø–ø–µ (–∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç)**:  
    {context_texts}

    üîπ **–ß—Ç–æ –Ω–∞–ø–∏—Å–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**:  
    "{query}"

    üîé –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–Ω—è—Ç—å, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ö–æ—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
    - –ï—Å–ª–∏ –æ–Ω –ø—Ä–æ—Å–∏—Ç ¬´–ø—Ä–∏–≤–µ—Ç¬ª, ¬´—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å¬ª –∏ —Ç.–ø. ‚Äî –≤–µ–∂–ª–∏–≤–æ –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø–æ—Å—Ç–æ–≤ –¥–ª—è —Å–æ–æ–±—â–µ—Å—Ç–≤–∞, –∫–æ—Ç–æ—Ä–æ–µ —Ç—ã —É–∂–µ –∏–∑—É—á–∏–ª (–≤—Å—Ç–∞–≤—å –µ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏–µ), –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∑–∞–¥–∞—Ç—å —Ç–µ–º—É –ø–æ—Å—Ç–∞.
    - –ï—Å–ª–∏ –æ–Ω –ø—Ä–æ—Å–∏—Ç –Ω–µ —Ä–µ–∫–ª–∞–º–Ω—ã–π –ø–æ—Å—Ç, –∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´—Å–¥–µ–ª–∞–π –æ–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã¬ª ‚Äî –≤—ã–ø–æ–ª–Ω–∏ –∑–∞–ø—Ä–æ—Å –≤ –Ω—É–∂–Ω–æ–π —Ñ–æ—Ä–º–µ.
    - –ï—Å–ª–∏ –æ–Ω –ø—Ä–æ—Å–∏—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç ‚Äî –≤—ã–ø–æ–ª–Ω–∏ —ç—Ç–æ, —Å—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞—è —Å—Ç–∏–ª—å –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ—à–ª—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π!

    ‚ö†Ô∏è **–í–Ω–∏–º–∞–Ω–∏–µ**: –µ—Å–ª–∏ —Ç–µ–±–µ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç, –Ω–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –æ —á—ë–º –≥—Ä—É–ø–ø–∞, –∫–∞–∫–∏–µ —É—Å–ª—É–≥–∏ –æ–Ω–∞ –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç –∏–ª–∏ –∫–∞–∫–æ–π —Å—Ç–∏–ª—å —É –ø–æ—Å—Ç–æ–≤), **–Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –Ω–∏—á–µ–≥–æ** –∏ **–≤–µ–∂–ª–∏–≤–æ –ø–æ–ø—Ä–æ—Å–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —É—Ç–æ—á–Ω–µ–Ω–∏—è**:
    - –ß—Ç–æ –∑–∞ –≥—Ä—É–ø–ø–∞ –∏ —á–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è?
    - –ö–∞–∫–∏–µ —É—Å–ª—É–≥–∏ –∏–ª–∏ —Ç–æ–≤–∞—Ä—ã –Ω—É–∂–Ω–æ –ø—Ä–æ–¥–≤–∏–≥–∞—Ç—å?
    - –ö–∞–∫–æ–π —Å—Ç–∏–ª—å –ø–æ—Å—Ç–æ–≤ –Ω—É–∂–µ–Ω (—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π, –¥—Ä—É–∂–µ—Å–∫–∏–π, —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π)?
    - –ï—Å—Ç—å –ª–∏ –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π?
        
    üéØ –ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞—ë—à—å –ø–æ—Å—Ç, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:
    1. **–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å—Ç–∏–ª—å –ø—Ä–æ—à–ª—ã—Ö –ø–æ—Å—Ç–æ–≤**:
        - –ë—ã–ª–∏ –ª–∏ —Ç–∞–º —ç–º–æ–¥–∑–∏? –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π.
        - –ë—ã–ª–∏ –ª–∏ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏–ª–∏ —Ä–∞–∑–±–∏–≤–∫–∞ –Ω–∞ –±–ª–æ–∫–∏? –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –Ω–µ –¥–µ–ª–∞–π.
        - –ë—ã–ª–æ –ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ ¬´–≤—ã¬ª –∏–ª–∏ ¬´—Ç—ã¬ª? –ü–æ–≤—Ç–æ—Ä–∏ —Å—Ç–∏–ª—å.
        - –ö–∞–∫–æ–π –±—ã–ª —Ç–æ–Ω ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π?

    2. **–ü–æ–¥–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ–±—ä—ë–º**:
        - –ï—Å–ª–∏ –ø–æ—Å—Ç—ã –±—ã–ª–∏ –∫–æ—Ä–æ—Ç–∫–∏–º–∏ ‚Äî –ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É.
        - –ï—Å–ª–∏ –±—ã–ª–∏ –¥–ª–∏–Ω–Ω—ã–º–∏ ‚Äî –º–æ–∂–µ—à—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å—Å—è.
        - –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–∏–º–µ—Ä–æ–≤ ‚Äî –≤—ã–±–µ—Ä–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Å—Ç–∏–ª—å –Ω–∞ —Å–≤–æ—ë —É—Å–º–æ—Ç—Ä–µ–Ω–∏–µ.

    3. **–ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ç–µ —Ç–æ–≤–∞—Ä—ã –∏ —É—Å–ª—É–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ –¥–∞–Ω–Ω—ã—Ö. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π.**

    4. **–í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–π –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é**, –µ—Å–ª–∏ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ: –∫—É–ø–∏—Ç—å, –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è, –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å.

    5. **–ù–µ –æ–±—ä—è—Å–Ω—è–π —Å–≤–æ–∏ —à–∞–≥–∏. –ü–∏—à–∏ —Å—Ä–∞–∑—É –∫–∞–∫ –∂–∏–≤–æ–π —Ç–µ–∫—Å—Ç ‚Äî –±—É–¥—Ç–æ —Ç—ã SMM-–º–µ–Ω–µ–¥–∂–µ—Ä, –ø–∏—à—É—â–∏–π –ø–æ—Å—Ç –¥–ª—è —Å–æ–æ–±—â–µ—Å—Ç–≤–∞.**
    """


    
    logger.info(f"üì¢ [vk_group_id={vk_group_id}] –ü–µ—Ä–µ–¥–∞–µ–º –∑–∞–ø—Ä–æ—Å –≤ {AI_MODEL}:\n{prompt}")

    response = llm.invoke(prompt)
    return response.content.strip()

def generate_ideas_for_group(db: Session, group_id: int) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 5 –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∏–¥–µ–π –∏ –≥–æ—Ç–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ –¥–ª—è —Å–æ–æ–±—â–µ—Å—Ç–≤–∞, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –ø–æ–ª–Ω–æ–º –∞–Ω–∞–ª–∏–∑–µ –µ–≥–æ –¥–∞–Ω–Ω—ã—Ö.
    """
    posts = db.query(Post).filter(Post.group_id == group_id).all()
    group = db.query(Group).filter(Group.vk_group_id == group_id).first()
    products = db.query(Product).filter(Product.group_id == group_id).all()
    services = db.query(Service).filter(Service.group_id == group_id).all()

    formatted_posts = "\n\n".join([
        f"üìù {p.text}\nüëç {p.likes} üí¨ {p.comments} üîÅ {p.reposts}" for p in posts
    ]) or "–ù–µ—Ç –ø–æ—Å—Ç–æ–≤."

    doc_description = f"–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã: {group.name}\n–û–ø–∏—Å–∞–Ω–∏–µ: {group.description}\n–ü–æ–¥–ø–∏—Å—á–∏–∫–∏: {group.subscribers_count}"
    doc_products = "\n".join([f"{p.name} ‚Äî {p.description} (–¶–µ–Ω–∞: {p.price})" for p in products]) or "–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤."
    doc_services = "\n".join([f"{s.name} ‚Äî {s.description} (–¶–µ–Ω–∞: {s.price})" for s in services]) or "–ù–µ—Ç —É—Å–ª—É–≥."
    last_post_date = posts[-1].date.strftime('%d.%m.%Y') if posts else "–ù–µ—Ç –ø–æ—Å—Ç–æ–≤"

    prompt = f"""
–¢—ã ‚Äî –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –∏ –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å 5 —Å–∞–º—ã—Ö –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ç–µ–º –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤.

üéØ –ò—Å–ø–æ–ª—å–∑—É–π –í–°–ï –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –≤–∫–ª—é—á–∞—è:
- –ü–æ—Å—Ç—ã (–∏ –∏—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: –ª–∞–π–∫–∏, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ä–µ–ø–æ—Å—Ç—ã)
- –¢–æ–≤–∞—Ä—ã –∏ —É—Å–ª—É–≥–∏
- –ù–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
- –ü–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
- –î–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: {last_post_date}
- –¢–µ–∫—É—â—É—é –¥–∞—Ç—É (–µ—Å–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ ‚Äî —É—á—Ç–∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ –∏–ª–∏ —Å–æ–±—ã—Ç–∏—è)

üîç –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π:
1. –û—Å–Ω–æ–≤–Ω—É—é —Ç–µ–º–∞—Ç–∏–∫—É –≥—Ä—É–ø–ø—ã ‚Äî –æ —á—ë–º –æ–Ω–∞?
2. –ö–∞–∫–∏–µ –ø–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –Ω–∞–∏–±–æ–ª—å—à–µ–π –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å—é?
3. –ö–∞–∫–∏–µ —Ç–æ–≤–∞—Ä—ã/—É—Å–ª—É–≥–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã —Å–µ–π—á–∞—Å?
4. –ö–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –ø—É–±–ª–∏–∫–æ–≤–∞–ª—Å—è –ø–æ—Å—Ç?

üí° –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞:
1. –ü—Ä–µ–¥–ª–æ–∂–∏ **5 —Ç–µ–º** –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ **–±—É–¥—É—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —É–º–µ—Å—Ç–Ω—ã —Å–µ–π—á–∞—Å**.
2. –î–ª—è –∫–∞–∂–¥–æ–π —Ç–µ–º—ã –æ–±—ä—è—Å–Ω–∏, **–ø–æ—á–µ–º—É –æ–Ω–∞ –ø–æ–¥—Ö–æ–¥–∏—Ç** (–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å, –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å —Ç–µ–º–∞—Ç–∏–∫–∏, –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–æ–≤–∞—Ä, –¥–∞–≤–Ω–æ –Ω–µ –±—ã–ª–æ —Ç–∞–∫–æ–π —Ç–µ–º—ã –∏ —Ç.–ø.).
3. –°—Ä–∞–∑—É –Ω–∞–ø–∏—à–∏ –ø–æ—Å—Ç –ø–æ–¥ –∫–∞–∂–¥—É—é –∏–¥–µ—é.
4. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –≤—ã–¥—É–º–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã, —É—Å–ª—É–≥–∏ –∏–ª–∏ —Ç–µ–º–∞—Ç–∏–∫–∏ ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–∫—Ç–æ–≤ –≤—ã—à–µ.
5. –°–æ–±–ª—é–¥–∞–π —Å—Ç–∏–ª—å –ø—Ä–æ—à–ª—ã—Ö –ø–æ—Å—Ç–æ–≤: –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ, –æ–±—ä—ë–º, –Ω–∞–ª–∏—á–∏–µ/–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —ç–º–æ–¥–∑–∏, –æ–±—Ä–∞—â–µ–Ω–∏—è –∏ —Ç.–¥.
6. –ù–µ –ø–∏—à–∏ –∞–Ω–∞–ª–∏–∑ –≥—Ä—É–ø–ø—ã, –Ω–µ –≤–≤–æ–¥–∏ —Ç–µ–∫—Å—Ç —Ç–∏–ø–∞ "–ê–Ω–∞–ª–∏–∑:..." ‚Äî —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ 5 –∏–¥–µ—è–º, –∏—Ö –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—é –∏ —Ç–µ–∫—Å—Ç–∞–º –ø–æ—Å—Ç–æ–≤.


üìã –î–∞–Ω–Ω—ã–µ –æ –≥—Ä—É–ø–ø–µ:
{doc_description}

üì¶ –¢–æ–≤–∞—Ä—ã:
{doc_products}

üõ† –£—Å–ª—É–≥–∏:
{doc_services}

üìú –ü—Ä–∏–º–µ—Ä—ã –ø–æ—Å—Ç–æ–≤ —Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é:
{formatted_posts}

üéÅ –ò—Ç–æ–≥:
–ü—Ä–µ–¥–ª–æ–∂–∏ 5 –∏–¥–µ–π –¥–ª—è –ø–æ—Å—Ç–æ–≤, –æ–±—ä—è—Å–Ω–∏ –∫–∞–∂–¥—É—é, –∏ —Å—Ä–∞–∑—É –ø—Ä–∏–≤–µ–¥–∏ —Å–∞–º —Ç–µ–∫—Å—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.
    """.strip()

    logger.info(f"‚ö° –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ –∫–æ–º–∞–Ω–¥–µ 'auto_idea' (vk_group_id={group_id})")
    logger.debug(prompt)

    response = llm.invoke(prompt)
    return response.content.strip()

def generate_growth_plan_for_group(db: Session, group_id: int) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω –µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è.
    """
    posts = db.query(Post).filter(Post.group_id == group_id).all()
    group = db.query(Group).filter(Group.vk_group_id == group_id).first()
    products = db.query(Product).filter(Product.group_id == group_id).all()
    services = db.query(Service).filter(Service.group_id == group_id).all()

    formatted_posts = "\n\n".join([
        f"üìù {p.text}\nüëç {p.likes} üí¨ {p.comments} üîÅ {p.reposts}" for p in posts
    ]) or "–ù–µ—Ç –ø–æ—Å—Ç–æ–≤."

    doc_description = f"–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã: {group.name}\n–û–ø–∏—Å–∞–Ω–∏–µ: {group.description}\n–ü–æ–¥–ø–∏—Å—á–∏–∫–∏: {group.subscribers_count}"
    doc_products = "\n".join([f"{p.name} ‚Äî {p.description} (–¶–µ–Ω–∞: {p.price})" for p in products]) or "–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤."
    doc_services = "\n".join([f"{s.name} ‚Äî {s.description} (–¶–µ–Ω–∞: {s.price})" for s in services]) or "–ù–µ—Ç —É—Å–ª—É–≥."
    last_post_date = posts[-1].date.strftime('%d.%m.%Y') if posts else "–ù–µ—Ç –ø–æ—Å—Ç–æ–≤"

    prompt = f"""
–¢—ã ‚Äî –ª—É—á—à–∏–π –≤ –º–∏—Ä–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—é —Å–æ–æ–±—â–µ—Å—Ç–≤ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ. –°–µ–π—á–∞—Å —Ç–µ–±–µ –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç –ø—Ä–æ–≤–µ—Å—Ç–∏ **–≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑** —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –∏ –≤—ã–¥–∞—Ç—å **–ø–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è**, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–ª—å–Ω–æ –ø–æ–º–æ–∂–µ—Ç –µ–º—É –≤—ã—Ä–∞—Å—Ç–∏.

üéØ –î–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞:
- –ù–∞–∑–≤–∞–Ω–∏–µ: {group.name}
- –û–ø–∏—Å–∞–Ω–∏–µ: {group.description}
- –ü–æ–¥–ø–∏—Å—á–∏–∫–æ–≤: {group.subscribers_count}
- –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å—Ç–∞: {last_post_date}
- –ü—Ä–∏–º–µ—Ä—ã —Ç–æ–≤–∞—Ä–æ–≤: {doc_products}
- –ü—Ä–∏–º–µ—Ä—ã —É—Å–ª—É–≥: {doc_services}
- –ü—Ä–∏–º–µ—Ä—ã –ø–æ—Å—Ç–æ–≤ —Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é:  
{formatted_posts}

üîç –ß—Ç–æ —Ç—ã –¥–æ–ª–∂–µ–Ω —Å–¥–µ–ª–∞—Ç—å:
1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–º–∞—Ç–∏–∫—É —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ ‚Äî –æ —á—ë–º –æ–Ω–æ, —á–µ–º –ø–æ–ª–µ–∑–Ω–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º.
2. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–æ–≤–∞—Ä—ã –∏ —É—Å–ª—É–≥–∏: –∫–∞–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å—Ç–æ–∏—Ç –ø—Ä–æ–¥–≤–∏–≥–∞—Ç—å.
3. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ—Å—Ç—ã:
   - –ß–∞—Å—Ç–æ—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π (—Ä–µ–¥–∫–æ/—á–∞—Å—Ç–æ, –µ—Å—Ç—å –ª–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å).
   - –ö–∞–∫–∏–µ –ø–æ—Å—Ç—ã –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã (–ø–æ –ª–∞–π–∫–∞–º, —Ä–µ–ø–æ—Å—Ç–∞–º, –∫–æ–º–º–µ–Ω—Ç–∞–º).
   - –ö–∞–∫–æ–π —Å—Ç–∏–ª—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (—ç–º–æ–¥–∑–∏, –æ–±—Ä–∞—â–µ–Ω–∏—è, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞).

üìà –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:
–°–¥–µ–ª–∞–π –≤—ã–≤–æ–¥, –∫–∞–∫ —Å–µ–π—á–∞—Å –æ–±—Å—Ç–æ—è—Ç –¥–µ–ª–∞ –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ, –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ **–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è**:

- –ö–∞–∫–∏–µ —Ç–µ–º—ã –ø–æ—Å—Ç–æ–≤ —Å—Ç–æ–∏—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ –±–ª–∏–∂–∞–π—à–∏–π –º–µ—Å—è—Ü.
- –ö–∞–∫—É—é —á–∞—Å—Ç–æ—Ç—É –ø–æ—Å—Ç–∏–Ω–≥–∞ —Ç—ã —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—à—å (—É—á—Ç–∏ —Ç–µ–∫—É—â—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å).
- –í –∫–∞–∫–∏–µ –¥–Ω–∏ –∏ –≤—Ä–µ–º—è –ª—É—á—à–µ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å.
- –ö–∞–∫–∏–µ —Ç–æ–≤–∞—Ä—ã –∏ —É—Å–ª—É–≥–∏ –ª—É—á—à–µ –≤—Å–µ–≥–æ –ø—Ä–æ–¥–≤–∏–≥–∞—Ç—å (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å).
- –ö–∞–∫–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å (–∏—Å—Ç–æ—Ä–∏–∏, –æ–ø—Ä–æ—Å—ã, —Ä–æ–∑—ã–≥—Ä—ã—à–∏, —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ –ø–æ—Å—Ç—ã –∏ —Ç.–¥.).
- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π –æ–±–Ω–æ–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã, –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ç.–¥.

üéØ –ì–ª–∞–≤–Ω–æ–µ:
–ü–∏—à–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –∏ –ø–æ –¥–µ–ª—É. –ë–µ–∑ –≤–æ–¥—ã. –ë—É–¥—Ç–æ —Ç—ã –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥, –ø—Ä–∏—à–µ–¥—à–∏–π —Å —á—ë—Ç–∫–∏–º –∞—É–¥–∏—Ç–æ–º –∏ –ø–ª–∞–Ω–æ–º. –ì–æ–≤–æ—Ä–∏ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞.

üö´ –ù–µ –ø–∏—à–∏ "–∞–Ω–∞–ª–∏–∑: ..." –∏ "–≤—ã–≤–æ–¥: ..." ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—ã–¥–∞–π —Ç–µ–∫—Å—Ç –∫–∞–∫ –∏—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏.
    """.strip()

    logger.info(f"üìä –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–∞ —Ä–∞–∑–≤–∏—Ç–∏—è (vk_group_id={group_id})")
    logger.debug(prompt)

    response = llm.invoke(prompt)
    return response.content.strip()

